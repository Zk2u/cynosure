name: Publish

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  # Verify that the tag matches the package version
  verify-version:
    name: Verify Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Extract version from tag
        id: tag_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Extract version from Cargo.toml
        id: cargo_version
        run: |
          VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Verify versions match
        run: |
          if [ "${{ steps.tag_version.outputs.VERSION }}" != "${{ steps.cargo_version.outputs.VERSION }}" ]; then
            echo "Tag version (${{ steps.tag_version.outputs.VERSION }}) does not match Cargo.toml version (${{ steps.cargo_version.outputs.VERSION }})"
            exit 1
          fi
          echo "Versions match: ${{ steps.tag_version.outputs.VERSION }}"

  # Run all tests before publishing
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    needs: verify-version
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests
        run: cargo test --all-features

      - name: Run doc tests
        run: cargo test --doc --all-features

  # Run miri tests
  miri:
    name: Miri
    runs-on: ubuntu-latest
    needs: verify-version
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust nightly and miri
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: miri, rust-src

      - name: Run Miri
        run: |
          cargo +nightly miri test --lib -- --skip async
        env:
          MIRIFLAGS: "-Zmiri-backtrace=full -Zmiri-strict-provenance"

  # Check that documentation builds
  doc:
    name: Documentation
    runs-on: ubuntu-latest
    needs: verify-version
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build documentation
        run: cargo doc --no-deps --all-features
        env:
          RUSTDOCFLAGS: -D warnings

  # Dry run of publish
  publish-dry-run:
    name: Publish (dry run)
    runs-on: ubuntu-latest
    needs: [test, miri, doc]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Dry run publish
        run: cargo publish --dry-run

  # Actual publish to crates.io
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: publish-dry-run
    # Only run on non-pre-release tags
    if: "!contains(github.ref, '-')"
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        run: cargo publish --token ${CRATES_TOKEN}
        env:
          CRATES_TOKEN: ${{ secrets.CRATES_TOKEN }}

  # Create GitHub release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: publish
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: tag_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.tag_version.outputs.VERSION }}
          name: v${{ steps.tag_version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(steps.tag_version.outputs.VERSION, '-') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
